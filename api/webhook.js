const { Telegraf, Markup } = require("telegraf");

if (!process.env.TELEGRAM_BOT_TOKEN) {
  throw new Error("TELEGRAM_BOT_TOKEN is not defined");
}

const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN);

/* ===========================
   START COMMAND
=========================== */

bot.start(async (ctx) => {
  const firstName = ctx.from?.first_name || "Ð“Ð¾ÑÑ‚ÑŒ";

  await ctx.replyWithMarkdown(
    `ðŸ‘‹ *Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ, ${firstName}!*

Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² *Campus Eats* ðŸ½

ÐœÑ‹ â€” ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ ÐµÐ´Ñ‹ Ð´Ð»Ñ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¾Ð² Ð¸ ÐºÐ°Ð¼Ð¿ÑƒÑÐ¾Ð².

â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸš€ *Ð§Ñ‚Ð¾ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ:*

â€¢ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ñ‹  
â€¢ ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð· Ð·Ð° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÐºÐ»Ð¸ÐºÐ¾Ð²  
â€¢ ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸  
â€¢ ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ Ð±Ð¾Ð½ÑƒÑÑ‹ Ð¸ ÐºÑÑˆÐ±ÐµÐº  

â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Ð•ÑÐ»Ð¸ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ½ÑƒÑ‚ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ â€” Ð½Ð°ÑˆÐ° Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð²ÑÐµÐ³Ð´Ð° Ð½Ð° ÑÐ²ÑÐ·Ð¸:
ðŸ“© *Support:* @CampusEats

Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½Ð¸Ð¶Ðµ ðŸ‘‡`,
    Markup.keyboard([
      ["ðŸ½ ÐœÐµÐ½ÑŽ Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð¾Ð²"],
      ["ðŸ“¦ ÐœÐ¾Ð¸ Ð·Ð°ÐºÐ°Ð·Ñ‹", "ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ"],
      ["â„¹ï¸ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ"]
    ])
      .resize()
      .persistent()
  );
});

/* ===========================
   HELP
=========================== */

bot.help(async (ctx) => {
  await ctx.replyWithMarkdown(
    `â„¹ï¸ *Campus Eats â€” ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ*

Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:

/start â€” Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ  
/help â€” ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ  

Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ»Ð¸ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ð·Ð°ÐºÐ°Ð·Ð¾Ð¼:

ðŸ“© Support: @CampusEats`
  );
});

/* ===========================
   MENU BUTTONS HANDLER
=========================== */

bot.hears("ðŸ½ ÐœÐµÐ½ÑŽ Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð¾Ð²", async (ctx) => {
  await ctx.reply(
    "Ð Ð°Ð·Ð´ÐµÐ» Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð¾Ð² ÑÐºÐ¾Ñ€Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ ðŸš€"
  );
});

bot.hears("ðŸ“¦ ÐœÐ¾Ð¸ Ð·Ð°ÐºÐ°Ð·Ñ‹", async (ctx) => {
  await ctx.reply(
    "Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð¾Ð² Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒÑÑ Ð·Ð´ÐµÑÑŒ Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ backend."
  );
});

bot.hears("ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ", async (ctx) => {
  await ctx.reply(
    "Ð Ð°Ð·Ð´ÐµÐ» Ð±Ð°Ð»Ð°Ð½ÑÐ° Ð¸ Ð±Ð¾Ð½ÑƒÑÐ½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ."
  );
});

bot.hears("â„¹ï¸ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ", async (ctx) => {
  await ctx.reply(
    "Ð”Ð»Ñ ÑÐ²ÑÐ·Ð¸ Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ: @CampusEats"
  );
});

/* ===========================
   FALLBACK
=========================== */

bot.on("text", async (ctx) => {
  await ctx.reply(
    "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð· Ð¼ÐµÐ½ÑŽ Ð½Ð¸Ð¶Ðµ ðŸ‘‡"
  );
});

/* ===========================
   VERCEL HANDLER
=========================== */

module.exports = async (req, res) => {
  try {
    if (req.method !== "POST") {
      return res.status(200).send("OK");
    }

    await bot.handleUpdate(req.body);
    return res.status(200).send("OK");
  } catch (error) {
    console.error("Webhook error:", error);
    return res.status(500).send("Internal Server Error");
  }
};
